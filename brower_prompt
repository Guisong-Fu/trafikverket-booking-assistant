v0.1:

task=f"""
### Prompt for Swedish Driving License Booking Agent 

**Objective:**
Visit [Trafikverket](https://fp.trafikverket.se/Boka/ng/licence), click the desired license type, then in the actual booking page(url started with https://fp.trafikverket.se/Boka/ng/search/ ), fill in the information accordingly and see if there is any slot that meets user's requirment, if so, return the time information of that slot , if not, do nothing.

**Important:**
- The site is all in Swedish, but the request from user can be in whatever language they want. You need to be able to understand it. 
- Wait for each element to load before interacting
- Make sure all the information is correctly set, license type, exam location, type of rental car.
- Scroll only if it's needed
---

Here are the specific steps:

---

### Step 1: Navigate to the booking page
- Go to [Trafikverket](https://fp.trafikverket.se/Boka/ng/licence)

####Expected Result 
- all types of licenses are displayed

---

### Step 2: Choose the desired license type

choose and click the specific {exam_request.license_type} type of exam, the exam type needs to match exactly {exam_request.test_type}


####Expected Result 
- Once done, you should be nevigated to a page with URL started with `https://fp.trafikverket.se/Boka/ng/search/`. Make sure the selected option from `Vad vill du boka?` matches exactly {exam_request.test_type}, if not, click the section block and choose the right one.
- The exact {exam_request.license_type} is chosen



---
### Step 3: Choose the desired test type(practical driving test or theory test)


in "Välj prov", choose {exam_request.test_type} type of test
The options can be Practical Driving test or Theory test. 


####Expected Result 
- The exact {exam_request.test_type} is chosen

---
### Step 4: Fill in the diesred test location


- click "Var vill du göra provet?", and it will pop out a inside window `Välj provort`, in `Filtrera på ort`, type in `Sok ort` with choose {', '.join(exam_request.location)}  one by one, if it's gets displayed, then click that location, once clicked, the background of that location will be turned into dark red, and "right arrow icon" will become "right icon", and `Välj provort (0/4)` will be `Välj provort (1/4)` or `Välj provort (2/4)` up to `Välj provort (4/4)`



####Expected Result 
- all desired locations for test are correctly selected.
- only the desired ones are chosen, nothing more

---
### Step 5: Confirm chosen location
Click `bekräfta`, once done, that window shall be closed, and the locations dispayed in `Var vill du göra provet?` match exactly {', '.join(exam_request.location)}.
If not matched, then repat Step 4.

####Expected Result 
- locations dispayed in `Var vill du göra provet?` match exactly {', '.join(exam_request.location)}


---
### Step 6: Choose the desired rental car type(automatic or manual)
in "Välj bil att hyra från Trafikverket.", choose {exam_request.transmission_type} 


####Expected Result 
- The exact {exam_request.transmission_type} is chosen

---
### Step 7: Check and see if there is the time slot 

Under `Lediga provtider`, ta list of available slots will be displaed
- see if there is a slot that matches the preferred time mentioned in the {', '.join(exam_request.time_preference)}, if so, return that result


####Expected Result 
- if there is such slot that matches the the time perference, then return that time information of that slot
- if no, then return not found

---
### Step 8: log out
- click "Logga ut"
- Then click "Ja, logga ut"


####Expected Result 
- Successfully logged out

---

There are two questions:
1. If the location chosed is not correct, I said it shall repeat Step 4, but I shall also include more detailed instruction, like you need to unclick everything.
2. In the available timeslots, there is `Hämta fler tider`, it shall be able to click that, but I may limit it to a certain times. -> probably this should be in a dedicated agent with restricted amount of steps?








v0.2
### 🔑  Swedish Driving-Licence Booking — Browser-Use Agent

**Goal**  
Log in to Trafikverket’s booking service and return the first appointment that matches the user’s request
(or “NOT FOUND” if none exists), then log out.

---

## 💡  Runtime variables
- {{license_type}}        e.g. `"B"`, `"AM"`, `"BE"`
- {{exam_kind}}           `"Teoriprov"` or `"Körprov"`
- {{locations}}           comma-separated list, max 4, in Swedish (e.g. `"Göteborg,Mölndal"`)
- {{transmission}}        `"Manuell"` or `"Automat"`
- {{time_windows}}        list of natural-language expressions understood by chrono.js  
                          (e.g. `"nästa vecka"`, `"före 2025-05-31 18:00"`)

---

## 🛠  General rules
1. **Always wait** (`await …`) for each element before interacting.  
2. **Do not translate UI labels** – select by visible Swedish text.  
3. **Scroll only when element is off-screen.**  
4. **Abort immediately** after you have (a) extracted a matching slot **or** (b) confirmed no slots; then log out.  
5. **Return JSON** in the form  
   ```json
   { "status": "OK" | "NOT_FOUND",
     "slot":  { "date": "YYYY-MM-DD", "time": "HH:MM", "location": "…"} | null }



⸻

▶️  Step-by-step

1 · Open booking start page

GET https://fp.trafikverket.se/Boka/ng/licence
 ✔ Expect all licence-category cards to be visible.

2 · Select licence & exam kind

Click the card whose title exactly equals {{license_type}}.
The URL must now start …/search/.
In dropdown “Vad vill du boka?” choose the option that exactly equals {{exam_kind}}.

3 · Pick test category

In “Välj prov” tick the radio button for {{exam_kind}} (“Teoriprov” or “Körprov”).

4 · Choose test locations

Click “Var vill du göra provet?” → modal “Välj provort”.
For each item in {{locations}}:
	•	type into “Sök ort”,
	•	wait for the row to appear,
	•	click it (row turns dark-red).
Ensure the counter reads Välj provort (n/4) where n = length of {{locations}}.
Press “Bekräfta”; the chip list now matches {{locations}}.

5 · Select rental-car gearbox

Under “Välj bil att hyra från Trafikverket.” choose {{transmission}}.

6 · Scan available slots

Wait for “Lediga provtider” table to load.
Parse each row; if its date-time falls inside any interval in {{time_windows}},
→ store slot info and skip to Step 7.
If end of list reached with no match → set status "NOT_FOUND".

7 · Logout

Click “Logga ut” → “Ja, logga ut”.
Return the JSON described in General rules § 5.

End of prompt

---

## Why these changes

### Strong typing & clear placeholders  
Named curly-brace variables separate **static instructions** from **dynamic user input**, making the task reusable while preventing accidental hard-coding.  This pattern is recommended for programmatic agents that inject runtime data.  [oai_citation:0‡Trafikverket](https://www.trafikverket.se/e-tjanster/boka-och-betala-korkortsprov/?utm_source=chatgpt.com) [oai_citation:1‡Trafikverket](https://www.trafikverket.se/korkort/?utm_source=chatgpt.com)

### Early-exit & JSON output  
The booking API rate-limits clients, and Trafikverket explicitly asks users to release sessions quickly to avoid locking timeslots  [oai_citation:2‡fp.trafikverket.se](https://fp.trafikverket.se/Boka/?utm_source=chatgpt.com).  An early-exit design reduces needless navigation and protects against session timeout.  JSON ensures the calling code can safely parse results without string-splitting.  [oai_citation:3‡Trafikverket](https://www.trafikverket.se/om-oss/kontakta-oss/vara-forarprovskontor/?utm_source=chatgpt.com)

### Exact-text selectors  
Trafikverket’s UI labels (“Vad vill du boka?”, “Välj prov”, “Var vill du göra provet?”) appear verbatim across all licence categories  [oai_citation:4‡Trafikverket](https://www.trafikverket.se/e-tjanster/boka-och-betala-korkortsprov/?utm_source=chatgpt.com) [oai_citation:5‡trafiktestet.se](https://www.trafiktestet.se/524/boka_korkortsprov?utm_source=chatgpt.com).  Selecting by exact visible text is more reliable than positional selectors, which often change when Trafikverket A/B-tests its layout.  [oai_citation:6‡Trafikverket](https://www.trafikverket.se/korkort/ta-korkort/personbil-och-latt-lastbil/?utm_source=chatgpt.com)  

### Robust location picker logic  
The “Välj provort (0/4)” counter increments as each city is ticked; verifying that counter gives a free integrity check before closing the modal.  Trafikverket’s help pages emphasise that a user may book at **up to four** test sites  [oai_citation:7‡trafiktestet.se](https://www.trafiktestet.se/524/boka_korkortsprov?utm_source=chatgpt.com).

### Human-readable time windows  
Using chrono-style expressions lets end-users type natural Swedish or English (“före 09:00 imorgon”, “next Friday afternoon”).  Parsing those in code is trivial and removes rigid date-pickers from the prompt itself.  Trafikverket silently releases cancelled slots at random times – checking broad windows catches those drops  [oai_citation:8‡Trafikverket](https://www.trafikverket.se/korkort/ta-korkort/?utm_source=chatgpt.com).

### Minimal scrolling + awaits  
Trafikverket injects rows via AJAX; un-awaited clicks often fail because DOM nodes haven’t rendered  [oai_citation:9‡fp.trafikverket.se](https://fp.trafikverket.se/Boka/?utm_source=chatgpt.com).  The new ruleset makes explicit that every action must be preceded by an await on the relevant selector.









